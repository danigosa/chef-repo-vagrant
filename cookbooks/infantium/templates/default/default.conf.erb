server {
    server_name  infantium.com;
    return       301 http://<%= node[:inf_version] %>.infantium.com$request_uri;
}

server {
    listen              80;
    listen              443 ssl;
    ssl_certificate     /usr/local/nginx/conf/sslchain.crt;
    ssl_certificate_key /usr/local/nginx/conf/infantium.com.key;
    server_name         <%= node[:inf_version] %>.infantium.com;
    location /static {
        alias /var/www/infantium_portal/infantium/static;
    }
    location /media {
        alias /var/www/infantium_portal/infantium/media;
    }
    location / {
        include     uwsgi_params;
        uwsgi_pass  unix:/tmp/uwsgi.sock;
        uwsgi_param UWSGI_PYHOME /var/www/infantium_portal/env;
        uwsgi_param UWSGI_CHDIR /var/www/infantium_portal/infantium;
        uwsgi_param UWSGI_MODULE infantium.wsgi:application;
    }
    location ~ [^(/static|/media)](.*)(admin|accounts|members|api) {
        include     uwsgi_params;
        uwsgi_pass  unix:/tmp/uwsgi.sock;
        uwsgi_param UWSGI_PYHOME /var/www/infantium_portal/env;
        uwsgi_param UWSGI_CHDIR /var/www/infantium_portal/infantium;
        uwsgi_param UWSGI_MODULE infantium.wsgi:application;
        # force pages to use https
        if ($scheme = "http") {
            rewrite ^ https://$host$request_uri break;
        }
    }
}

server {
    listen 80 default;
    server_name _;
    rewrite ^ $scheme://<%= node[:inf_version] %>.infantium.com$request_uri;
}